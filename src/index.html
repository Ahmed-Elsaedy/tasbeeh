<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taseeh Thumb Button — BLE tester</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:18px}
    button{padding:10px 14px;font-size:16px}
    pre{background:#f6f8fa;padding:12px;border-radius:6px;white-space:pre-wrap}
    .ok{color:green}.err{color:crimson}
  </style>
</head>
<body>
  <h1>Taseeh Thumb Button — BLE tester</h1>
  <p>This page helps you detect and subscribe to a Bluetooth Low Energy (BLE) thumb button. 
  It will first try to connect as a GATT client and subscribe to any "notify" characteristic it finds. 
  If your button works as a Bluetooth keyboard/media (HID), instead use the keyboard listener below.</p>

  <p>
    <button id="scanBtn">Scan &amp; connect to device</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </p>

  <h2>Detected info</h2>
  <pre id="log">Ready.

Notes:
- Web Bluetooth works only over HTTPS (or localhost).
- Many simple Bluetooth buttons either implement HID (acts like a keyboard/media remote) or a custom BLE service with a "button" characteristic.
- If your device pairs as a keyboard (you see it in OS as input device), the easiest method may be to listen for key events (code below).
</pre>

  <h2>Keyboard fallback (if the button acts like a keyboard/HID)</h2>
  <p>Press the button and see the key events below — useful for devices exposing HID (keyboard) profile.</p>
  <pre id="kbdLog">No keyboard events yet.
</pre>

<script>
const scanBtn = document.getElementById('scanBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const logEl = document.getElementById('log');
const kbdLog = document.getElementById('kbdLog');
let device = null;
let server = null;
let activeNotifications = [];

function log(...args){
  console.log(...args);
  logEl.textContent += '\n' + args.map(a=> (typeof a === 'object'? JSON.stringify(a): String(a))).join(' ');
  logEl.scrollTop = logEl.scrollHeight;
}

function klog(...args){
  kbdLog.textContent += '\n' + args.join(' ');
  kbdLog.scrollTop = kbdLog.scrollHeight;
}

// Keyboard fallback listener
window.addEventListener('keydown', e => {
  klog(`keydown: key="${e.key}" code="${e.code}" keyCode=${e.keyCode}`);
});

scanBtn.addEventListener('click', async () => {
  try{
    log('Requesting Bluetooth device...');
    // We ask the user to pick any device. You can replace acceptAllDevices with filters if you know the name or services.
    device = await navigator.bluetooth.requestDevice({
      // acceptAllDevices: true requires a user gesture (this button click) and shows all BLE devices in range
      acceptAllDevices: true,
      optionalServices: [] // we will discover services after connecting
    });

    log('Selected device:', device.name || '(no name)', device.id);

    device.addEventListener('gattserverdisconnected', onDisconnected);

    log('Connecting to GATT server...');
    server = await device.gatt.connect();
    log('Connected — discovering services...');

    const services = await server.getPrimaryServices();
    log('Found services:', services.map(s=>s.uuid).join(', '));

    // For every service, list characteristics and subscribe to notify ones
    for (const service of services){
      try{
        log('\nService', service.uuid);
        const characteristics = await service.getCharacteristics();
        for (const c of characteristics){
          const props = [];
          if (c.properties.read) props.push('read');
          if (c.properties.write) props.push('write');
          if (c.properties.notify) props.push('notify');
          if (c.properties.indicate) props.push('indicate');

          log('  Char', c.uuid, 'props=', props.join(','));

          // If notify -> subscribe
          if (c.properties.notify || c.properties.indicate){
            await c.startNotifications();
            const onNotif = (event) => {
              const value = event.target.value;
              // convert bytes to hex and try to parse
              const arr = [];
              for (let i=0;i<value.byteLength;i++) arr.push(('0'+value.getUint8(i).toString(16)).slice(-2));
              log(`\nNotification from ${c.uuid}: 0x${arr.join(' ')} (len=${value.byteLength})`);

              // Heuristic: many buttons send a single byte 0 or 1, or 0x01 when pressed
              if (value.byteLength === 1){
                const b = value.getUint8(0);
                if (b === 1) log('>>> Button PRESSED (value=1)');
                else if (b === 0) log('>>> Button RELEASED (value=0)');
                else log('>>> Single byte:', b);
              } else {
                // try ASCII
                try{
                  const text = new TextDecoder().decode(value);
                  log('>>> Text decode:', text);
                }catch(e){
                  // ignore
                }
              }
            };
            c.addEventListener('characteristicvaluechanged', onNotif);
            activeNotifications.push({char: c, handler: onNotif});
          }
        }
      }catch(err){
        log('Error enumerating characteristics for', service.uuid, err);
      }
    }

    disconnectBtn.disabled = false;
    scanBtn.disabled = true;
    log('\nSetup complete. Press the physical button and watch for notifications.');

  }catch(err){
    log('Error during scan/connect:', err);
  }
});

async function onDisconnected(){
  log('Device disconnected');
  disconnectBtn.disabled = true;
  scanBtn.disabled = false;
}

disconnectBtn.addEventListener('click', async () => {
  if (!device) return;
  try{
    // stop notifications
    for (const n of activeNotifications){
      try{ await n.char.stopNotifications(); n.char.removeEventListener('characteristicvaluechanged', n.handler);}catch(_){}
    }
    activeNotifications = [];

    if (device.gatt.connected) await device.gatt.disconnect();
    log('Disconnected.');
  }catch(err){
    log('Error while disconnecting:', err);
  }finally{
    disconnectBtn.disabled = true;
    scanBtn.disabled = false;
  }
});
</script>
</body>
</html>
